---

title: Title

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 05-Census_Bureau_urban_areas.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># From https://www2.census.gov/geo/pdfs/reference/GARM/Ch12GARM.pdf:</span>

<span class="c1"># &quot;Urbanized Areas (UAs)</span>
<span class="c1"># A UA is a continuously built-up area with a population of 50,000 or more.</span>
<span class="c1"># It comprises one or more places—central place(s)—and the adjacent densely settled surrounding </span>
<span class="c1"># area—urban fringe—consisting of other places and nonplace territory.&quot;</span>

<span class="c1"># &quot;Urban Places Outside of UAs</span>
<span class="c1"># Outside of UAs, an urban place is any incorporated place or census designated place (CDP) with </span>
<span class="c1"># at least 2,500 inhabitants. A CDP is a densely settled population center that has a name and </span>
<span class="c1"># community identity, and is not part of any incorporated place.&quot;</span>

<span class="c1"># &quot;Rural Places and Territory</span>
<span class="c1"># Territory, population, and housing units that the Census Bureau does not classify as urban are classified </span>
<span class="c1"># as rural.&quot;</span>

<span class="c1"># Census Urban Areas and Urban Clusters are not based on political boundaries at all.</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># (Takes about 1.25 clock minutes.)</span>
<span class="n">year</span> <span class="o">=</span> <span class="mi">2017</span>
<span class="n">infile</span> <span class="o">=</span> <span class="s1">&#39;data/df_</span><span class="si">%d</span><span class="s1">_OMB.csv&#39;</span> <span class="o">%</span> <span class="n">year</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 1min 17s, sys: 11.4 s, total: 1min 29s
Wall time: 1min 28s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># To use a df copy instead of reading it in again. Uncomment the useful line.</span>
<span class="c1">#df_copy = df.copy()</span>
<span class="c1">#df = df_copy.copy()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">99999</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>883453
4
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>935</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Add the Urban Area (UA) to each row by matching InfoGroup &#39;CBSA Code&#39; (metro/micropolitan area) to the Census</span>
<span class="c1"># Relationship file that cross-references CBSA and UA.</span>
<span class="n">relationship</span> <span class="o">=</span> <span class="s1">&#39;Relationship_Files/Urban_Area_to_Metro_Micro_Area_utf-8.csv&#39;</span>
<span class="n">rel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cbsa_list</span> <span class="o">=</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">ua_list</span> <span class="o">=</span> <span class="n">rel</span><span class="p">[</span><span class="s1">&#39;UA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cbsa_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span>
<span class="n">ua_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cbsa_list</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ua_list</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>955
3601
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># The file contains a record for all metro/micro areas (CBSAs) and all urban areas/clusters (UAs) in 2010.</span>
<span class="c1"># Exploration:</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">[[</span><span class="s1">&#39;UA&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># There are 5167 records in the file, all with paired values of UA and CBSA that are unique.</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">[[</span><span class="s1">&#39;UA&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]][</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">99999</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">[[</span><span class="s1">&#39;UA&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]][</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">99999</span><span class="p">]),</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># There are 1038 records with a valid UA code but NO metro/micro area (CBSA).</span>
<span class="c1"># There are 4129 UAs with a valid CBSA.</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">[[</span><span class="s1">&#39;UA&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]][</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;UA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">99999</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">[[</span><span class="s1">&#39;UA&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]][</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;UA&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">99999</span><span class="p">]),</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># There are 955 records with a valid CBSA code but NO urban area/cluster (UA).</span>
<span class="c1"># There are 4212 CBSAs with a valid UA.</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">[(</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">99999</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;UA&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">99999</span><span class="p">)]))</span>
<span class="c1"># There are 3174 records with valid unique combinations of the CBSA and UA values.</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">[(</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">99999</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;UA&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">99999</span><span class="p">)]))</span>
<span class="c1"># By definition there are no cases in which both the CBSA and UA are missing.</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>5167
5167 

1038
4129 

955
4212 

3174
0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rel</span><span class="p">[</span><span class="s1">&#39;UA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>956
3602
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># ----------------------------</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># The above means that on the average there are is least a part of more than 3 UA&#39;s for each CBSA. Thus the</span>
<span class="c1"># only way to get a one-to-one mapping of CBSA to UA will be to do the shapely &#39;within&#39; comparison; determine</span>
<span class="c1"># whether the point coordinates of an IG enterprise fall within the polygon coordinates of a particular UA.</span>

<span class="c1"># But to create a simple &#39;rural_Census&#39; flag we need only to discover whether the CBSA Code of the IG record</span>
<span class="c1"># matches any CBSA code in the relationship file that is not in an urban area.</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Is a UA in a CBSA 1) partly, 2) entirely, or 3) not at all?</span>
<span class="c1"># Make a dict with the UA as the key and the value a list of all CBSA codes.</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># The uas dict has a list of CBSAs for each UA. The ua_keys dict tags each UA as rural, partly rural, or</span>
<span class="c1"># urban. But in InfoGroup we have only CBSA Code. We can determine if the IG record&#39;s CBSA Code matches to a UA that </span>
<span class="c1"># is entirely urban and that is completely within the CBSA; i.e., it has only the IG record&#39;s CBS code in its</span>
<span class="c1"># CBSA list. And if it matches to a UA that is entirely rural; i.e., the UA has only a single 99999 in its CBSA list.</span>

<span class="c1"># The cbsas dict is a reverse version of uas: a key for every CBSA and, as the value, the list of UAs associated</span>
<span class="c1"># with the key. The cbsas_keys dict substitutes the urban/rural tag of each UA for its code value. Using those </span>
<span class="c1"># lists of text values we can determine whethera record is rural, partly rural, or urban.</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># UA key</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Create dict from list of lists.</span>
<span class="n">uas</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">rel</span><span class="p">[[</span><span class="s1">&#39;UA&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uas</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">uas</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Validate that 99999 can occur only once in any value list in the uas dict.</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">uas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">99999</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
        
<span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0 1038
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Categorize all the UAs as urban, rural, partly rural, or unknown.</span>
<span class="c1"># Partly rural == UA with some valid CBSAs and at least 1 99999;</span>
<span class="c1"># Rural (entirely rural) == UA with no valid CBSAs, just some 99999s;</span>
<span class="c1"># Urban (not at all rural) == UA with some valid CBSAs but no 99999s.</span>
<span class="c1"># Unknown == UA 99999 (missing)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">all_nines</span><span class="p">(</span><span class="n">li</span><span class="p">):</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="mi">99999</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">length</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ua_keys</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">uas</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">uas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">all_nines</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="n">ua_keys</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rural-multi&#39;</span>
        <span class="k">elif</span> <span class="mi">99999</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">ua_keys</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;partly rural&#39;</span>
        <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">99999</span><span class="p">:</span>
            <span class="n">ua_keys</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ua_keys</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;urban-multi&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">99999</span><span class="p">:</span>
            <span class="n">ua_keys</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rural-single&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ua_keys</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;urban-single&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Validate that all keys have values [and remove the key for UA 99999].</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ua_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ua_keys</span><span class="p">[</span><span class="mi">99999</span><span class="p">])</span>

<span class="c1"># No, don&#39;t delete the key for 99999</span>
<span class="c1">#del ua_keys[99999]</span>
<span class="c1">#try:</span>
<span class="c1">#    print(ua_keys[99999])</span>
<span class="c1">#except KeyError:</span>
<span class="c1">#    print(&#39;No such key&#39;)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>unknown
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">len_att</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ua_keys</span><span class="p">)</span>
<span class="n">entire</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">urban</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">part</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">unk</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ua_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rural-single&#39;</span><span class="p">,</span><span class="s1">&#39;rural-multi&#39;</span><span class="p">]:</span>
        <span class="n">entire</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;partly rural&#39;</span><span class="p">:</span>
        <span class="n">part</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;urban-single&#39;</span><span class="p">,</span><span class="s1">&#39;urban-multi&#39;</span><span class="p">]:</span>
        <span class="n">urban</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
        <span class="n">unk</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Out of&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">len_att</span><span class="p">),</span><span class="s1">&#39;UAs:&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">entire</span><span class="p">),</span><span class="s1">&#39;are entirely rural,&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">),</span><span class="s1">&#39;are partly rural,&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="nb">str</span><span class="p">(</span><span class="n">urban</span><span class="p">),</span><span class="s1">&#39;are urban, and&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">unk</span><span class="p">),</span><span class="s1">&#39;is unknown.&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Out of 3602 UAs: 
 908 are entirely rural, 
 130 are partly rural, 
 2563 are urban, and 
 1 is unknown.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="mi">2563</span><span class="o">/</span><span class="mi">3602</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="mi">908</span><span class="o">/</span><span class="mi">3602</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="mi">130</span><span class="o">/</span><span class="mi">3602</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="mi">1</span><span class="o">/</span><span class="mi">3602</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>71.15491393670183
25.2082176568573
3.6091060521932263
0.027762354247640203
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># CBSA key</span>
<span class="c1"># a CBSA is not covered entirely by UAs, so is it valid to assess the rurality of a record if it only has a</span>
<span class="c1"># CBSA Code and no way to categorize the parts of the CBSA that are not covered by any UA?</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Create dict from list of lists.</span>
<span class="n">cbsas</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">rel</span><span class="p">[[</span><span class="s1">&#39;UA&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cbsas</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cbsas</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># function to remove all occurrences of a particular value from a list.</span>
<span class="k">def</span> <span class="nf">remove_all</span><span class="p">(</span><span class="n">li</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">li</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">li</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">li</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">del</span> <span class="n">cbsas</span><span class="p">[</span><span class="mi">99999</span><span class="p">]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cbsas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">cbsas</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_all</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="mi">99999</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">cbsas</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>955</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Find the list of UAs that are associated with a single CBSA code.</span>
<span class="k">def</span> <span class="nf">find_uas</span><span class="p">(</span><span class="n">cbsa</span><span class="p">):</span> 
    <span class="n">uas_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">uas</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#if k == 99999: </span>
            <span class="c1">#continue</span>
        <span class="k">if</span> <span class="n">cbsa</span> <span class="ow">in</span> <span class="n">uas</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
            <span class="n">uas_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uas_list</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Get a list of the urban/rural descriptions for each UA in a list of UAs.</span>
<span class="k">def</span> <span class="nf">find_descs</span><span class="p">(</span><span class="n">uas_list</span><span class="p">):</span>
    <span class="n">descs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ua</span> <span class="ow">in</span> <span class="n">uas_list</span><span class="p">:</span>
        <span class="n">descs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ua_keys</span><span class="p">[</span><span class="n">ua</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">descs_list</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Object:</span>
<span class="c1">#       cbsa_keys: a dict with CBSA codes as keys and empty lists to be filled in with urban/rural text strings as values.</span>

<span class="n">cbsa_keys</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">cbsas</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># Data: </span>
<span class="c1">#       uas: a dict with UA codes as keys and lists of constituent CBSAs as values.</span>
<span class="c1">#       uas_keys: a dict with UA codes as keys and one of &#39;rural&#39;,&#39;partly rural&#39;, and &#39;urban&#39; as a value.</span>
<span class="c1">#       cbsas: a dict with CBSA values as keys and lists of constituent UAs as values.</span>

<span class="k">for</span> <span class="n">cbsa</span> <span class="ow">in</span> <span class="n">cbsa_keys</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">find_uas</span><span class="p">(</span><span class="n">cbsa</span><span class="p">)</span>
    <span class="n">cbsa_keys</span><span class="p">[</span><span class="n">cbsa</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_descs</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Validation</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cbsas</span><span class="p">[</span><span class="mi">10020</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cbsa_keys</span><span class="p">[</span><span class="mi">10020</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ua_keys</span><span class="p">[</span><span class="mi">37</span><span class="p">],</span><span class="n">ua_keys</span><span class="p">[</span><span class="mi">43993</span><span class="p">],</span><span class="n">ua_keys</span><span class="p">[</span><span class="mi">46045</span><span class="p">],</span><span class="n">ua_keys</span><span class="p">[</span><span class="mi">99999</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[37, 43993, 46045]
[&#39;urban-multi&#39;, &#39;urban-single&#39;, &#39;urban-multi&#39;, &#39;unknown&#39;]
urban-multi urban-single urban-multi unknown
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Validation</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cbsas</span><span class="p">[</span><span class="mi">48140</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cbsa_keys</span><span class="p">[</span><span class="mi">48140</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ua_keys</span><span class="p">[</span><span class="mi">91</span><span class="p">],</span><span class="n">ua_keys</span><span class="p">[</span><span class="mi">55144</span><span class="p">],</span><span class="n">ua_keys</span><span class="p">[</span><span class="mi">93025</span><span class="p">],</span><span class="n">ua_keys</span><span class="p">[</span><span class="mi">99999</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[91, 55144, 93025]
[&#39;partly rural&#39;, &#39;urban-multi&#39;, &#39;urban-single&#39;, &#39;unknown&#39;]
partly rural urban-multi urban-single unknown
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Now add an &#39;invalid_rural_Census&#39; variable with appropriate values(?). Invalid because the logic is</span>
<span class="c1"># faulty, as it turns out. For example...</span>
<span class="c1"># If one description is &#39;partly rural&#39;, the whole CBSA is partly rural</span>
<span class="c1"># If there is a mixture of urban and rural (and partly rural), the whole CBSA is partly rural</span>
<span class="c1"># Otherwise, rural and urban are both all rural or all urban</span>
<span class="k">def</span> <span class="nf">assign_text</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">li</span> <span class="o">=</span> <span class="n">cbsa_keys</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;not available&#39;</span>
    
    <span class="k">if</span> <span class="s1">&#39;partly rural&#39;</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;partly rural&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;urban&#39;</span> <span class="ow">in</span> <span class="n">li</span> <span class="ow">and</span> <span class="s1">&#39;rural&#39;</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;partly rural&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;rural&#39;</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;rural&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;urban&#39;</span> <span class="ow">in</span> <span class="n">li</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;urban&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;invalid_rural_Census&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">assign_text</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;invalid_rural_Census&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>unknown          10099729
partly rural      2942686
not available     1691022
Name: invalid_rural_Census, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;invalid_rural_Census&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>unknown          68.549715
partly rural     19.972841
not available    11.477444
Name: invalid_rural_Census, dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># No cases in which all UAs for a CBSA are rural?</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cbsa_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;rural&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">n</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Are all the &#39;not availables&#39; KeyErrors? Yes.</span>
<span class="n">unknowns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">][</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;invalid_rural_Census&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;not available&#39;</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unknowns</span><span class="p">))</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">master</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cbsas</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="k">for</span> <span class="n">unk</span> <span class="ow">in</span> <span class="n">unknowns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">unk</span> <span class="ow">in</span> <span class="n">master</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># Thus 53 CBSA Codes in the InfoGroup file are not listed in the relationship file. These are the CBSA Code</span>
<span class="c1"># values for 1,691,022 records.</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>54
0
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Simple &#39;reverse-rurality&#39; indicator: for each CBSA in the InfoGroup file, does it match to any CBSA in the </span>
<span class="c1"># relationship file that is matched there to a valid UA code?</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pairs</span> <span class="o">=</span> <span class="n">rel</span><span class="p">[[</span><span class="s1">&#39;UA&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">))</span>
<span class="n">urban_cbsas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">99999</span> <span class="ow">or</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">99999</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">urban_cbsas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">urban_cbsas</span><span class="p">))</span>
<span class="n">urban_cbsas_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">urban_cbsas</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">urban_cbsas_set</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>5167
3174
955
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">isit_rural</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">urban_cbsas_set</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rural_Census_general&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">isit_rural</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rural_Census_general&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rural_Census_general&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0    13042415
1     1691022
Name: rural_Census_general, dtype: int64
0    88.522556
1    11.477444
Name: rural_Census_general, dtype: float64
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;invalid_rural_Census&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># ---------------------------------</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># For later analysis we will want the six-digit NAICS codes as well as the 8-digit code that comes with</span>
<span class="c1"># InfoGroup and the 2-digit code and description that we created in the #1 notebook.</span>
<span class="c1"># We&#39;ll also include some descriptions for some codes that the project statement mentions specifically as</span>
<span class="c1"># definitely agricultural.</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;NAICS6&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Primary NAICS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)[:</span><span class="mi">6</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ag_naics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;112112&#39;</span><span class="p">:</span><span class="s1">&#39;Cattle Feedlots&#39;</span><span class="p">,</span>
            <span class="s1">&#39;115111&#39;</span><span class="p">:</span><span class="s1">&#39;Cotton Ginning&#39;</span><span class="p">,</span>
            <span class="s1">&#39;115112&#39;</span><span class="p">:</span><span class="s1">&#39;Soil Preparation, Planting and Cultivating&#39;</span><span class="p">,</span>
            <span class="s1">&#39;115113&#39;</span><span class="p">:</span><span class="s1">&#39;Crop Harvesting, Primarily by Machine&#39;</span><span class="p">,</span>
            <span class="s1">&#39;115114&#39;</span><span class="p">:</span><span class="s1">&#39;Postharvest Crop Activities except Cotton Ginning&#39;</span><span class="p">,</span>
            <span class="s1">&#39;115115&#39;</span><span class="p">:</span><span class="s1">&#39;Farm Labor Contractors and Crew Leaders&#39;</span><span class="p">,</span>
            <span class="s1">&#39;115116&#39;</span><span class="p">:</span><span class="s1">&#39;Farm Management Services&#39;</span><span class="p">,</span>
            <span class="s1">&#39;423820&#39;</span><span class="p">:</span><span class="s1">&#39;Farm and Garden Machinery and Equipment Merchant Wholesalers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;424430&#39;</span><span class="p">:</span><span class="s1">&#39;Dairy Product Merchant Wholesalers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;424440&#39;</span><span class="p">:</span><span class="s1">&#39;Poultry and Poultry Product Merchant Wholesalers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;424480&#39;</span><span class="p">:</span><span class="s1">&#39;Fresh Fruit and Vegetable Merchant Wholesalers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;424510&#39;</span><span class="p">:</span><span class="s1">&#39;Grain and Field Bean Merchant Wholesalers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;424520&#39;</span><span class="p">:</span><span class="s1">&#39;Livestock Merchant Wholesalers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;424590&#39;</span><span class="p">:</span><span class="s1">&#39;Other Farm Product Raw Material Merchant Wholesalers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;424910&#39;</span><span class="p">:</span><span class="s1">&#39;Farm Supplies Merchant Wholesalers&#39;</span><span class="p">,</span>
            <span class="s1">&#39;493130&#39;</span><span class="p">:</span><span class="s1">&#39;Farm Product Warehousing and Storage&#39;</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">naics6_desc</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">ag_naics</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">ag_naics</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;NAICS6 desc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;NAICS6&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">naics6_desc</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;NAICS6 desc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Farm Supplies Merchant Wholesalers                              18210
Farm and Garden Machinery and Equipment Merchant Wholesalers    11859
Farm Product Warehousing and Storage                             4356
Fresh Fruit and Vegetable Merchant Wholesalers                   3829
Farm Management Services                                         2353
Livestock Merchant Wholesalers                                   2199
Dairy Product Merchant Wholesalers                               1276
Soil Preparation, Planting and Cultivating                       1211
Grain and Field Bean Merchant Wholesalers                        1119
Cattle Feedlots                                                  1063
Postharvest Crop Activities except Cotton Ginning                 669
Other Farm Product Raw Material Merchant Wholesalers              649
Poultry and Poultry Product Merchant Wholesalers                  623
Cotton Ginning                                                    428
Farm Labor Contractors and Crew Leaders                           255
Crop Harvesting, Primarily by Machine                             183
Name: NAICS6 desc, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;NAICS6 desc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>14683155</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Index([&#39;Company&#39;, &#39;Address Line 1&#39;, &#39;City&#39;, &#39;State&#39;, &#39;ZipCode&#39;, &#39;County Code&#39;,
       &#39;Primary SIC Code&#39;, &#39;SIC6_Descriptions&#39;, &#39;Primary NAICS Code&#39;,
       &#39;NAICS8 Descriptions&#39;, &#39;Employee Size (5) - Location&#39;,
       &#39;Sales Volume (9) - Location&#39;, &#39;Business Status Code&#39;,
       &#39;Industry Specific First Byte&#39;, &#39;Year Established&#39;, &#39;ABI&#39;,
       &#39;Subsidiary Number&#39;, &#39;Parent Number&#39;, &#39;Parent Actual Employee Size&#39;,
       &#39;Parent Actual Sales Volume&#39;, &#39;Census Tract&#39;, &#39;Census Block&#39;,
       &#39;Latitude&#39;, &#39;Longitude&#39;, &#39;CBSA Code&#39;, &#39;CBSA Level&#39;, &#39;FIPS Code&#39;,
       &#39;State FIPS&#39;, &#39;Continental&#39;, &#39;NAICS2&#39;, &#39;NAICS2 desc&#39;, &#39;CBSA Level desc&#39;,
       &#39;rural_OMB&#39;, &#39;rural_Census_general&#39;, &#39;NAICS6&#39;, &#39;NAICS6 desc&#39;],
      dtype=&#39;object&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}
outfile = 'data/df_%d_OMB_Census_TEMP.csv' % year
df.to_csv(outfile,index=None)
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># How to do the point-in-polygon comparison...</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}
%%time
year = 2017
infile = 'data/df_%d_OMB_Census_TEMP.csv' % year
df = pd.read_csv(infile,dtype=object)df[['Latitude','Longitude']] = df[['Latitude','Longitude']].apply(pd.to_numeric)dfx = df[['ABI','Latitude','Longitude']].sample(n=10000)def pointer(lon,lat):
    return Point(lon,lat)%%time
dfx['geometry'] = dfx.apply(lambda x: pointer(x['Longitude'], x['Latitude']), axis=1)dfx.drop(columns=['Latitude','Longitude'],inplace=True)The 2010 Urban Area to Metropolitan and Micropolitan Statistical Areas Relationship File provides relationships between the 2010 urban areas and the Metro and Micro Areas. Urban areas include both urbanized areas (UA) and urban clusters (UC), and areas outside urban areas are considered rural. 

This list can be utilized to see if a metro or micro area is urban, rural, or contains both urban and rural area.

Each record in the relationship file represents one polygon that is formed when the 2010 urban areas overlay the metro and micro areas. The polygon may represent the intersection of a 2010 urban area and a metro or micro area, or the portion of the metro or micro area that does not contain a 2010 urban area. In addition, since metro and micro areas are not a wall-to-wall coverage across the U.S., the polygon may represent the area of a 2010 urban area that does not intersect a metro and micro area.# The polygons of the UAs.
shape = 'map_files/tl_2017_us_uac10.shp'
ua = gpd.read_file(shape)#ua.columnsua.set_index("UACE10", inplace = True)ua_dict = dict.fromkeys(ua.index)
for k in ua_dict.keys():
    ua_dict[k] = ua.loc[k]['geometry']def set_ua(pnt):
    for k,p in ua_dict.items():
        if pnt.within(p):
            return k
    return '99999'%%time
dfx['UA'] = dfx.apply(lambda row: set_ua(row['geometry']),axis=1)# vectorized execution of a function that takes 4 params. faster than .apply()
#df['distance'] = haversine(40.671, -73.985, df['latitude'], df['longitude'])
# even better: use numpy arrays produced under the hood by .values
#df['distance'] = haversine(40.671, -73.985, df['latitude'].values, df['longitude'].values)
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># The 15 programs in the points-in-polygons folder ran simultaneously as a brute force method of parallel </span>
<span class="c1"># processing to locate the InfoGroup points in UA polygons. They incorporate the logic, maybe not the exact code,</span>
<span class="c1"># of the non-executable cells just above. They produced 15 csv files with the UA code for</span>
<span class="c1"># the UA record along with the shapely geometry and the ABI of the record.  Now combine those 15 files into </span>
<span class="c1"># one and merge the result into the df dataframe.</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">pp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="s1">&#39;points-in-polygons/data/dfx_</span><span class="si">%d</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="n">seq</span>
    <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">pp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pp_df</span><span class="p">,</span><span class="n">df_tmp</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pp_df</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>14733437
CPU times: user 1min 18s, sys: 4.93 s, total: 1min 22s
Wall time: 29.3 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pp_df</span><span class="p">[</span><span class="s1">&#39;ABI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df</span><span class="p">[</span><span class="s1">&#39;ABI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># Merge with df</span>
<span class="n">df_final</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pp_df</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;ABI&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span><span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_final</span><span class="o">.</span><span class="n">columns</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 1min 48s, sys: 26.3 s, total: 2min 14s
Wall time: 1min 12s
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Index([&#39;Company&#39;, &#39;Address Line 1&#39;, &#39;City&#39;, &#39;State&#39;, &#39;ZipCode&#39;, &#39;County Code&#39;,
       &#39;Primary SIC Code&#39;, &#39;SIC6_Descriptions&#39;, &#39;Primary NAICS Code&#39;,
       &#39;NAICS8 Descriptions&#39;, &#39;Employee Size (5) - Location&#39;,
       &#39;Sales Volume (9) - Location&#39;, &#39;Business Status Code&#39;,
       &#39;Industry Specific First Byte&#39;, &#39;Year Established&#39;, &#39;ABI&#39;,
       &#39;Subsidiary Number&#39;, &#39;Parent Number&#39;, &#39;Parent Actual Employee Size&#39;,
       &#39;Parent Actual Sales Volume&#39;, &#39;Census Tract&#39;, &#39;Census Block&#39;,
       &#39;Latitude&#39;, &#39;Longitude&#39;, &#39;CBSA Code&#39;, &#39;CBSA Level&#39;, &#39;FIPS Code&#39;,
       &#39;State FIPS&#39;, &#39;Continental&#39;, &#39;NAICS2&#39;, &#39;NAICS2 desc&#39;, &#39;CBSA Level desc&#39;,
       &#39;rural_OMB&#39;, &#39;rural_Census_general&#39;, &#39;NAICS6&#39;, &#39;NAICS6 desc&#39;,
       &#39;geometry&#39;, &#39;UA&#39;, &#39;_merge&#39;],
      dtype=&#39;object&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>both          14733437
right_only           0
left_only            0
Name: _merge, dtype: int64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># The polygon &#39;geometry&#39; is no longer necessary. Ditto for &#39;_merge&#39;.</span>
<span class="n">df_final</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span><span class="s1">&#39;_merge&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Create the definitive &#39;rural_Census&#39; variable.</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Informational</span>
<span class="n">rural_pct</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_final</span><span class="p">[</span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;UA&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;99999&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_final</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rural percentage by the most specific Census-based standard&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">rural_pct</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Rural percentage by the most specific Census-based standard 13.762579634337868
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;rural_Census&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;UA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;99999&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_final</span><span class="p">[</span><span class="s1">&#39;rural_Census&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0    86.23742
1    13.76258
Name: rural_Census, dtype: float64</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># In the InfoGroup file we now have the Urban Area identifier. That can be merged with locational variables from </span>
<span class="c1"># the Census shapefile for mapping. The output file here is a regular .csv file, not a shapefile, but it does have</span>
<span class="c1"># identifiers and coordinates for each UA and can be read into a GeoDataFrame.</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_final</span><span class="o">.</span><span class="n">columns</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Index([&#39;Company&#39;, &#39;Address Line 1&#39;, &#39;City&#39;, &#39;State&#39;, &#39;ZipCode&#39;, &#39;County Code&#39;,
       &#39;Primary SIC Code&#39;, &#39;SIC6_Descriptions&#39;, &#39;Primary NAICS Code&#39;,
       &#39;NAICS8 Descriptions&#39;, &#39;Employee Size (5) - Location&#39;,
       &#39;Sales Volume (9) - Location&#39;, &#39;Business Status Code&#39;,
       &#39;Industry Specific First Byte&#39;, &#39;Year Established&#39;, &#39;ABI&#39;,
       &#39;Subsidiary Number&#39;, &#39;Parent Number&#39;, &#39;Parent Actual Employee Size&#39;,
       &#39;Parent Actual Sales Volume&#39;, &#39;Census Tract&#39;, &#39;Census Block&#39;,
       &#39;Latitude&#39;, &#39;Longitude&#39;, &#39;CBSA Code&#39;, &#39;CBSA Level&#39;, &#39;FIPS Code&#39;,
       &#39;State FIPS&#39;, &#39;Continental&#39;, &#39;NAICS2&#39;, &#39;NAICS2 desc&#39;, &#39;CBSA Level desc&#39;,
       &#39;rural_OMB&#39;, &#39;rural_Census_general&#39;, &#39;NAICS6&#39;, &#39;NAICS6 desc&#39;, &#39;UA&#39;,
       &#39;rural_Census&#39;],
      dtype=&#39;object&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">outfile</span> <span class="o">=</span> <span class="s1">&#39;data/df_</span><span class="si">%d</span><span class="s1">_OMB_Census.csv&#39;</span> <span class="o">%</span> <span class="n">year</span>
<span class="n">df_final</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 9min 54s, sys: 8.25 s, total: 10min 2s
Wall time: 10min 4s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

