---

title: Title

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03-fix_CBSA.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cbsa_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/home/tflory/notebooks/InfoGroup/rurality/Relationship_Files/cbsa-county-relationships-2017.csv&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;STCOU&#39;</span><span class="p">,</span><span class="s1">&#39;CBSA&#39;</span><span class="p">,</span><span class="s1">&#39;LSAD&#39;</span><span class="p">])</span>
<span class="n">cbsa_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;-9&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cbsa_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;STCOU&#39;</span><span class="p">:</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">extract_corrections</span><span class="p">(</span><span class="n">unknowns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extracts CBSA Code and appropriate CBSA Level for a list of InfoGroup FIPS Codes&quot;&quot;&quot;</span>
    <span class="c1"># Files cross-references CBSA codes and county FIPS codes.</span>
    <span class="c1"># Variable &#39;STCOU&#39; is the 5-digit county FIPS code. The CBSA Level is inferred from the</span>
    <span class="c1"># text in the &#39;LSAD&#39; variable.</span>
    <span class="n">cbsa_df</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbsa_df</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unknowns</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">unk</span> <span class="o">=</span> <span class="n">unknowns</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cbsa_df</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">lsuffix</span><span class="o">=</span><span class="s1">&#39;_l&#39;</span><span class="p">,</span><span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;_r&#39;</span><span class="p">)</span>
    <span class="n">unk</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unk</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">unk</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;LSAD&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Metropolitan&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">unk</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">unk</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;LSAD&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Micropolitan&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">unk</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">unk</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">cbsa_text</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">yr</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;urban&#39;</span>
        <span class="k">elif</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">9</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rural&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span> 
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rural&#39;</span>
        <span class="k">elif</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;CBSA Text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;????&#39;</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1997</span><span class="p">,</span><span class="mi">2018</span><span class="p">):</span>
    <span class="n">in_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/InfoGroup/data/rurality/df_</span><span class="si">{</span><span class="n">yr</span><span class="si">}</span><span class="s1">_uncorrected.csv&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">in_fname</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FIPS Code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;00000&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">urban</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">urban</span><span class="p">[</span><span class="s1">&#39;CBSA Text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;urban&#39;</span>
    <span class="n">rural</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span>
    <span class="n">rural</span><span class="p">[</span><span class="s1">&#39;CBSA Text&#39;</span><span class="p">]</span> <span class="o">=</span><span class="s1">&#39;rural&#39;</span>
    <span class="n">unknown</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">))]</span>
    
    <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">sum_of_parts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">urban</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">rural</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sum_of_parts</span> <span class="o">!=</span> <span class="n">nrows</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">yr</span><span class="si">}</span><span class="s1"> Error in dividing enterprises into categories:&#39;</span><span class="p">)</span>
          <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">nrows</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">sum_of_parts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="n">corrected</span> <span class="o">=</span> <span class="n">extract_corrections</span><span class="p">(</span><span class="n">unknown</span><span class="p">)</span>
    <span class="n">corrected</span> <span class="o">=</span> <span class="n">cbsa_text</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span><span class="n">yr</span><span class="p">)</span>
    <span class="n">corrected</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CBSA&#39;</span><span class="p">,</span><span class="s1">&#39;FIPS Code_r&#39;</span><span class="p">,</span><span class="s1">&#39;LSAD&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">corrected</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FIPS Code_l&quot;</span><span class="p">:</span> <span class="s2">&quot;FIPS Code&quot;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="s1">&#39;CBSA Level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">urban</span><span class="p">,</span><span class="n">rural</span><span class="p">,</span><span class="n">corrected</span><span class="p">],</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s1">&#39;CBSA Text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

    <span class="n">out_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/InfoGroup/data/rurality/InfoGroup_final_</span><span class="si">{</span><span class="n">yr</span><span class="si">}</span><span class="s1">.csv&#39;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_fname</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
*** 1997 ***
0    794019
2      6891
1      4690
Name: CBSA Level, dtype: int64
urban    10469902
rural      794019
Name: CBSA Text, dtype: int64

*** 1998 ***
0    770262
2      6748
1      4601
Name: CBSA Level, dtype: int64
urban    10003949
rural      770262
Name: CBSA Text, dtype: int64

*** 1999 ***
0    789067
2      7062
1      4679
Name: CBSA Level, dtype: int64
urban    10230999
rural      789067
Name: CBSA Text, dtype: int64

*** 2000 ***
0    792797
2      7093
1      4798
Name: CBSA Level, dtype: int64
urban    10376479
rural      792797
Name: CBSA Text, dtype: int64

*** 2001 ***
0    903899
2      8265
1      5345
Name: CBSA Level, dtype: int64
urban    11645485
rural      903899
Name: CBSA Text, dtype: int64

*** 2002 ***
0    910425
2      8283
1      5410
Name: CBSA Level, dtype: int64
urban    11938524
rural      910425
Name: CBSA Text, dtype: int64

*** 2003 ***
0    887255
2      7966
1      5282
Name: CBSA Level, dtype: int64
urban    11768331
rural      887255
Name: CBSA Text, dtype: int64

*** 2004 ***
0    891977
2      8038
1      5278
Name: CBSA Level, dtype: int64
urban    11631985
rural      891977
Name: CBSA Text, dtype: int64

*** 2005 ***
0    926047
2      8273
1      5140
Name: CBSA Level, dtype: int64
urban    12169577
rural      926047
Name: CBSA Text, dtype: int64

*** 2006 ***
0    907950
2      8011
1      5488
Name: CBSA Level, dtype: int64
urban    12322450
rural      907950
Name: CBSA Text, dtype: int64

*** 2007 ***
0    907979
2      7926
1      5223
Name: CBSA Level, dtype: int64
urban    12674361
rural      907979
Name: CBSA Text, dtype: int64

*** 2008 ***
0    901089
2      7992
1      5036
Name: CBSA Level, dtype: int64
urban    12865095
rural      901089
Name: CBSA Text, dtype: int64

*** 2009 ***
0    886663
2      7832
1      5078
Name: CBSA Level, dtype: int64
urban    12671100
rural      886663
Name: CBSA Text, dtype: int64

*** 2010 ***
0    917199
2      7868
1      5222
Name: CBSA Level, dtype: int64
urban    12806802
rural      917199
Name: CBSA Text, dtype: int64

*** 2011 ***
0    855484
2      7249
1      4425
Name: CBSA Level, dtype: int64
urban    12511551
rural      855484
Name: CBSA Text, dtype: int64

*** 2012 ***
0    952828
2      8063
1      5605
Name: CBSA Level, dtype: int64
urban    13667676
rural      952828
Name: CBSA Text, dtype: int64

*** 2013 ***
0    989306
2      8802
1      5951
Name: CBSA Level, dtype: int64
urban    14863416
rural      989306
Name: CBSA Text, dtype: int64

*** 2014 ***
0    1005921
2       8661
1       6159
Name: CBSA Level, dtype: int64
urban    14821188
rural     1005921
Name: CBSA Text, dtype: int64

*** 2015 ***
0    964258
1      5868
2      2098
Name: CBSA Level, dtype: int64
urban    14597226
rural      964258
Name: CBSA Text, dtype: int64

*** 2016 ***
0    934480
1      5699
2      1985
Name: CBSA Level, dtype: int64
urban    14685344
rural      934480
Name: CBSA Text, dtype: int64

*** 2017 ***
0    876022
1      5513
2      1922
Name: CBSA Level, dtype: int64
urban    13857415
rural      876022
Name: CBSA Text, dtype: int64
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

